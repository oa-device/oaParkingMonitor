<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Monitor Dashboard - Enterprise Management System</title>
    <style>
        /* Professional Enterprise Theme */
        :root {
            /* Professional Color Palette */
            --primary-green: #00ff88;
            --primary-green-muted: #00cc6b;
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2d2d2d;
            --bg-elevated: #232323;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #666666;
            --border-color: rgba(255, 255, 255, 0.1);
            --border-color-light: rgba(255, 255, 255, 0.15);
            
            /* Status Colors - Muted and Professional */
            --status-available: #28a745;
            --status-occupied: #dc3545;
            --status-warning: #ffc107;
            --status-error: #dc3545;
            --status-online: #00ff88;
            
            /* Shadows - Subtle */
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-elevated: 0 6px 16px rgba(0, 0, 0, 0.25);
            
            /* Spacing - Professional Scale */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Typography - Enterprise Scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            
            /* Radius - Minimal */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            
            /* Minimal Transitions */
            --transition-instant: 0ms;
            --transition-subtle: 150ms ease-out;
        }

        /* Professional Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Professional Layout */
        .app-container {
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-base);
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-lg);
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            display: block;
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .status-value {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .main-content {
            padding: var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-xl);
            align-items: start;
        }

        /* Professional Card Component */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-elevated);
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-content {
            padding: var(--spacing-lg);
        }

        /* Professional Camera View */
        .live-view {
            position: relative;
        }

        .camera-container {
            position: relative;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            aspect-ratio: 16/9;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        .camera-overlay {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            gap: var(--spacing-sm);
        }

        .camera-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        /* Professional Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--text-sm);
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
            transition: background-color var(--transition-subtle);
        }

        .btn-primary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color-light);
        }

        .btn-primary:hover {
            background: var(--bg-elevated);
            border-color: var(--primary-green);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-color-light);
        }

        /* Zone Grid */
        .zones-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .zone-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .zone-section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .zone-grid {
            display: grid;
            gap: var(--spacing-sm);
        }

        .zone-grid.front {
            grid-template-columns: repeat(7, 1fr);
        }

        .zone-grid.back {
            grid-template-columns: repeat(5, 1fr);
        }

        .zone {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            text-align: center;
            cursor: pointer;
            position: relative;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .zone.available {
            border-color: var(--status-available);
        }

        .zone.occupied {
            border-color: var(--status-occupied);
        }

        .zone.hard {
            border-color: var(--status-warning);
        }

        .zone-name {
            font-weight: 600;
            font-size: var(--text-sm);
            margin-bottom: var(--spacing-xs);
        }

        .zone-status {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .zone-confidence {
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        /* Professional Analytics Section */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .metric {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: var(--space-xs);
        }

        .metric-label {
            font-size: var(--text-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chart Container */
        .chart-container {
            height: 200px;
            margin-top: var(--space-lg);
            background: var(--surface-elevated);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        /* Professional Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Professional Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: var(--spacing-xs);
        }

        .status-dot.online {
            background: var(--status-online);
        }

        .status-dot.warning {
            background: var(--status-warning);
        }

        .status-dot.error {
            background: var(--status-error);
        }

        /* Fullscreen Modal */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .fullscreen-modal.active {
            display: flex;
        }

        .fullscreen-image {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }

        .fullscreen-close {
            position: absolute;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--text-xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-close:hover {
            background: var(--status-error);
            border-color: var(--status-error);
        }

        /* Professional Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 350px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .toast.success {
            border-color: var(--status-available);
        }

        .toast.error {
            border-color: var(--status-error);
        }

        /* Professional Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
                padding: var(--spacing-lg);
            }
            
            .header-content {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
                text-align: center;
            }
            
            .status-overview {
                order: 2;
            }
            
            .header-actions {
                order: 3;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .zone-grid.front {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .zone-grid.back {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .camera-controls {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: var(--spacing-md);
            }
            
            .main-content {
                padding: var(--spacing-md);
            }
        }

        @media (max-width: 480px) {
            .zone-grid.front {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .zone-grid.back {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .zone {
                min-height: 60px;
            }
            
            .status-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Professional Focus Styles */
        .btn:focus-visible,
        .zone:focus-visible {
            outline: 2px solid var(--primary-green);
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            .header-actions,
            .camera-overlay,
            .btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">P</div>
                    <span>Parking Monitor</span>
                </a>
                
                <div class="status-overview">
                    <div class="status-item">
                        <span class="status-label">Service Status</span>
                        <div class="status-value">
                            <span class="status-dot online" id="service-indicator"></span>
                            <span id="service-status">Online</span>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Total Spaces</span>
                        <span class="status-value" id="total-spaces">12</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Occupied</span>
                        <span class="status-value" id="occupied-spaces">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Occupancy</span>
                        <span class="status-value" id="occupancy-rate">0%</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-secondary" id="refresh-all">
                        Refresh All
                    </button>
                    <button class="btn btn-primary" id="export-data">
                        Export Data
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Live View Section -->
            <section class="live-view">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            Live Camera View
                            <span class="status-dot online" id="camera-status"></span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="camera-container" id="camera-container">
                            <img class="camera-image" id="camera-image" alt="Live parking view" style="display: none;">
                            <div class="loading-container" id="camera-loading">
                                <div class="spinner"></div>
                                <span>Loading live view...</span>
                            </div>
                            <div class="camera-overlay">
                                <button class="btn-icon" id="fullscreen-btn" title="View Fullscreen" aria-label="View fullscreen">
                                    ⛶
                                </button>
                                <button class="btn-icon" id="fit-mode-btn" title="Toggle Fit Mode" aria-label="Toggle fit mode">
                                    ◱
                                </button>
                                <button class="btn-icon" id="refresh-camera" title="Refresh Camera" aria-label="Refresh camera">
                                    ↻
                                </button>
                            </div>
                        </div>
                        
                        <div class="camera-controls">
                            <div class="metric">
                                <span class="metric-value" id="processing-fps">0.2</span>
                                <span class="metric-label">Processing FPS</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="detection-confidence">85%</span>
                                <span class="metric-label">Avg Confidence</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="model-status">Loading</span>
                                <span class="metric-label">AI Model</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="last-update">Never</span>
                                <span class="metric-label">Last Update</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Chart -->
                <div class="card" style="margin-top: var(--space-xl);">
                    <div class="card-header">
                        <h2 class="card-title">
                            Occupancy Analytics
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="chart-container" id="occupancy-chart">
                            <span>Historical occupancy chart will be displayed here</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Parking Zones -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            Parking Zones
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="zones-container">
                            <!-- Front Zones (A1-A7) -->
                            <div class="zone-section">
                                <h3 class="zone-section-title">Front Row (Easy Detection)</h3>
                                <div class="zone-grid front" id="front-zones">
                                    <!-- Zones will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Back Zones (B1-B5) -->
                            <div class="zone-section">
                                <h3 class="zone-section-title">Back Row (Advanced Detection)</h3>
                                <div class="zone-grid back" id="back-zones">
                                    <!-- Zones will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            System Analytics
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="analytics-grid">
                            <div class="metric">
                                <span class="metric-value status-dot success" id="available-count">12</span>
                                <span class="metric-label">Available</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="vehicles-detected">0</span>
                                <span class="metric-label">Vehicles</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="easy-zones">7</span>
                                <span class="metric-label">Easy Zones</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="hard-zones">5</span>
                                <span class="metric-label">Hard Zones</span>
                            </div>
                        </div>
                        
                        <!-- System Status -->
                        <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border);">
                            <h3 style="color: var(--text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-md);">System Health</h3>
                            <div class="analytics-grid">
                                <div class="metric">
                                    <span class="metric-value" id="uptime">0s</span>
                                    <span class="metric-label">Uptime</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value" id="next-snapshot">5s</span>
                                    <span class="metric-label">Next Scan</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreen-modal">
        <button class="fullscreen-close" id="fullscreen-close" title="Close Fullscreen">&times;</button>
        <img class="fullscreen-image" id="fullscreen-image" alt="Fullscreen parking view">
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        class ParkingMonitorPro {
            constructor() {
                // Configuration
                this.config = {
                    refreshInterval: 5000, // 5 seconds
                    maxRetries: 3,
                    retryDelay: 2000,
                    imageTimeout: 10000
                };

                // State management
                this.state = {
                    isOnline: true,
                    lastUpdate: 0,
                    retryCount: 0,
                    imageFitMode: 'contain', // contain, cover, fill
                    isFullscreen: false,
                    autoRefresh: true,
                    zones: new Map(),
                    analytics: {}
                };

                // DOM elements cache
                this.elements = {};

                // Initialize the application
                this.init();
            }

            async init() {
                try {
                    this.cacheElements();
                    this.setupEventListeners();
                    this.setupKeyboardShortcuts();
                    this.startAutoRefresh();
                    
                    // Initial data load
                    await this.loadAllData();
                    
                    this.showToast('Dashboard initialized successfully', 'success');
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showToast('Failed to initialize dashboard', 'error');
                }
            }

            cacheElements() {
                // Cache frequently used DOM elements
                this.elements = {
                    // Status elements
                    serviceStatus: document.getElementById('service-status'),
                    serviceIndicator: document.getElementById('service-indicator'),
                    totalSpaces: document.getElementById('total-spaces'),
                    occupiedSpaces: document.getElementById('occupied-spaces'),
                    occupancyRate: document.getElementById('occupancy-rate'),
                    
                    // Camera elements
                    cameraImage: document.getElementById('camera-image'),
                    cameraLoading: document.getElementById('camera-loading'),
                    cameraContainer: document.getElementById('camera-container'),
                    cameraStatus: document.getElementById('camera-status'),
                    
                    // Zone containers
                    frontZones: document.getElementById('front-zones'),
                    backZones: document.getElementById('back-zones'),
                    
                    // Analytics
                    processingFps: document.getElementById('processing-fps'),
                    detectionConfidence: document.getElementById('detection-confidence'),
                    modelStatus: document.getElementById('model-status'),
                    lastUpdate: document.getElementById('last-update'),
                    availableCount: document.getElementById('available-count'),
                    vehiclesDetected: document.getElementById('vehicles-detected'),
                    easyZones: document.getElementById('easy-zones'),
                    hardZones: document.getElementById('hard-zones'),
                    uptime: document.getElementById('uptime'),
                    nextSnapshot: document.getElementById('next-snapshot'),
                    
                    // Buttons
                    refreshAll: document.getElementById('refresh-all'),
                    exportData: document.getElementById('export-data'),
                    fullscreenBtn: document.getElementById('fullscreen-btn'),
                    fitModeBtn: document.getElementById('fit-mode-btn'),
                    refreshCamera: document.getElementById('refresh-camera'),
                    
                    // Fullscreen modal
                    fullscreenModal: document.getElementById('fullscreen-modal'),
                    fullscreenImage: document.getElementById('fullscreen-image'),
                    fullscreenClose: document.getElementById('fullscreen-close'),
                    
                    // Toast container
                    toastContainer: document.getElementById('toast-container')
                };
            }

            setupEventListeners() {
                // Header actions
                this.elements.refreshAll?.addEventListener('click', () => this.refreshAllData());
                this.elements.exportData?.addEventListener('click', () => this.exportData());
                
                // Camera controls
                this.elements.fullscreenBtn?.addEventListener('click', () => this.toggleFullscreen());
                this.elements.fitModeBtn?.addEventListener('click', () => this.cycleFitMode());
                this.elements.refreshCamera?.addEventListener('click', () => this.refreshCamera());
                
                // Fullscreen modal
                this.elements.fullscreenClose?.addEventListener('click', () => this.exitFullscreen());
                this.elements.fullscreenModal?.addEventListener('click', (e) => {
                    if (e.target === this.elements.fullscreenModal) {
                        this.exitFullscreen();
                    }
                });
                
                // Camera image click for fullscreen
                this.elements.cameraImage?.addEventListener('click', () => {
                    if (!this.state.isFullscreen) {
                        this.toggleFullscreen();
                    }
                });
                
                // Visibility change detection
                document.addEventListener('visibilitychange', () => {
                    this.handleVisibilityChange();
                });
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ignore if user is typing in input fields
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    switch (e.key.toLowerCase()) {
                        case 'r':
                            e.preventDefault();
                            this.refreshAllData();
                            break;
                        case 'f':
                            e.preventDefault();
                            this.cycleFitMode();
                            break;
                        case ' ':
                        case 'enter':
                            e.preventDefault();
                            this.toggleFullscreen();
                            break;
                        case 'escape':
                            if (this.state.isFullscreen) {
                                this.exitFullscreen();
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            this.exportData();
                            break;
                    }
                });
            }

            startAutoRefresh() {
                setInterval(() => {
                    if (this.state.autoRefresh && !document.hidden) {
                        this.loadAllData();
                    }
                }, this.config.refreshInterval);
            }

            async loadAllData() {
                try {
                    // Load data in parallel for better performance
                    const [detectionData, zonesData, statusData, analyticsData] = await Promise.allSettled([
                        this.fetchDetectionData(),
                        this.fetchZonesData(),
                        this.fetchStatusData(),
                        this.fetchAnalyticsData()
                    ]);

                    // Update UI with successful results
                    if (detectionData.status === 'fulfilled') {
                        this.updateOverviewStats(detectionData.value);
                    }
                    
                    if (zonesData.status === 'fulfilled') {
                        this.updateZoneDisplay(zonesData.value);
                    }
                    
                    if (statusData.status === 'fulfilled') {
                        this.updateSystemStatus(statusData.value);
                    }
                    
                    if (analyticsData.status === 'fulfilled') {
                        this.updateAnalytics(analyticsData.value);
                    }

                    // Always refresh the camera image
                    await this.updateCameraImage();
                    
                    this.updateServiceStatus(true);
                    this.updateLastUpdateTime();
                    this.state.retryCount = 0;

                } catch (error) {
                    console.error('Failed to load data:', error);
                    this.handleError(error);
                }
            }

            async fetchDetectionData() {
                const response = await this.fetchWithTimeout('/api/detection');
                return response.json();
            }

            async fetchZonesData() {
                const response = await this.fetchWithTimeout('/api/zones');
                return response.json();
            }

            async fetchStatusData() {
                const response = await this.fetchWithTimeout('/api/status');
                return response.json();
            }

            async fetchAnalyticsData() {
                const response = await this.fetchWithTimeout('/api/analytics?hours=1');
                return response.json();
            }

            async fetchWithTimeout(url, options = {}, timeout = 5000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response;
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            updateOverviewStats(data) {
                if (!data) return;

                // Update header stats
                this.elements.totalSpaces.textContent = data.total_spaces || 12;
                this.elements.occupiedSpaces.textContent = data.occupied_spaces || 0;
                
                const occupancyPercent = Math.round((data.occupancy_rate || 0) * 100);
                this.elements.occupancyRate.textContent = `${occupancyPercent}%`;
                
                // Update analytics section
                this.elements.vehiclesDetected.textContent = data.vehicles_detected || 0;
                this.elements.availableCount.textContent = (data.total_spaces || 12) - (data.occupied_spaces || 0);
                this.elements.easyZones.textContent = data.easy_zones_count || 7;
                this.elements.hardZones.textContent = data.hard_zones_count || 5;
                this.elements.processingFps.textContent = (data.processing_fps || 0.2).toFixed(1);
            }

            updateZoneDisplay(data) {
                if (!data?.zones) return;

                // Separate and sort zones
                const frontZones = data.zones
                    .filter(z => z.name.startsWith('A'))
                    .sort((a, b) => parseInt(a.name.slice(1)) - parseInt(b.name.slice(1)));
                
                const backZones = data.zones
                    .filter(z => z.name.startsWith('B'))
                    .sort((a, b) => parseInt(a.name.slice(1)) - parseInt(b.name.slice(1)));

                this.renderZones(this.elements.frontZones, frontZones);
                this.renderZones(this.elements.backZones, backZones);
            }

            renderZones(container, zones) {
                if (!container || !zones) return;

                const fragment = document.createDocumentFragment();

                zones.forEach(zone => {
                    const zoneElement = document.createElement('div');
                    zoneElement.className = 'zone';
                    zoneElement.setAttribute('data-zone', zone.name);
                    zoneElement.setAttribute('tabindex', '0');
                    zoneElement.setAttribute('role', 'button');
                    zoneElement.setAttribute('aria-label', `${zone.name}: ${zone.occupied ? 'Occupied' : 'Available'}`);

                    // Determine status class
                    let statusClass = 'available';
                    if (zone.occupied) {
                        statusClass = 'occupied';
                    } else if (zone.name.startsWith('B') || zone.detection_difficulty === 'hard') {
                        statusClass = 'hard';
                    }

                    zoneElement.classList.add(statusClass);

                    const confidence = zone.confidence ? Math.round(zone.confidence * 100) : 0;
                    
                    zoneElement.innerHTML = `
                        <div class="zone-name">${zone.name}</div>
                        <div class="zone-status">${zone.occupied ? 'Occupied' : 'Available'}</div>
                        ${confidence > 0 ? `<div class="zone-confidence">${confidence}% conf</div>` : ''}
                    `;

                    // Add click handler for zone details
                    zoneElement.addEventListener('click', () => this.showZoneDetails(zone));
                    
                    fragment.appendChild(zoneElement);
                });

                // Update container directly
                container.innerHTML = '';
                container.appendChild(fragment);
            }

            updateSystemStatus(data) {
                if (!data) return;

                // Update model status
                const modelStatus = data.model_loaded ? (data.model_name || 'Loaded') : 'Loading';
                this.elements.modelStatus.textContent = modelStatus;

                // Update uptime
                const uptimeSeconds = data.uptime_seconds || 0;
                this.elements.uptime.textContent = this.formatUptime(uptimeSeconds);

                // Update next snapshot countdown
                const nextSnapshotIn = Math.max(0, Math.round(data.next_snapshot_in || 5));
                this.elements.nextSnapshot.textContent = `${nextSnapshotIn}s`;
            }

            updateAnalytics(data) {
                if (!data) return;

                // Calculate average confidence from zones if available
                if (this.state.zones.size > 0) {
                    const validConfidences = Array.from(this.state.zones.values())
                        .filter(z => z.confidence > 0)
                        .map(z => z.confidence);
                    
                    const avgConfidence = validConfidences.length > 0
                        ? Math.round(validConfidences.reduce((a, b) => a + b, 0) / validConfidences.length * 100)
                        : 0;
                    
                    this.elements.detectionConfidence.textContent = `${avgConfidence}%`;
                }

                // Store analytics for potential chart rendering
                this.state.analytics = data;
            }

            async updateCameraImage() {
                try {
                    const timestamp = Date.now();
                    const imageUrl = `/api/snapshot?t=${timestamp}`;
                    
                    // Show loading state
                    this.elements.cameraImage.classList.add('loading');
                    
                    // Preload image for smooth transitions
                    const img = new Image();
                    img.onload = () => {
                        this.elements.cameraImage.src = img.src;
                        this.elements.cameraImage.style.objectFit = this.state.imageFitMode;
                        this.elements.cameraImage.style.display = 'block';
                        this.elements.cameraLoading.style.display = 'none';
                        this.elements.cameraImage.classList.remove('loading');
                        
                        // Update camera status indicator
                        this.elements.cameraStatus.className = 'status-dot online';
                    };
                    
                    img.onerror = () => {
                        this.elements.cameraImage.style.display = 'none';
                        this.elements.cameraLoading.style.display = 'flex';
                        this.elements.cameraLoading.innerHTML = `
                            <div style="color: var(--error); font-size: var(--text-2xl);">📷</div>
                            <span>Camera unavailable</span>
                        `;
                        this.elements.cameraStatus.className = 'status-dot error';
                    };
                    
                    img.src = imageUrl;

                } catch (error) {
                    console.error('Camera update failed:', error);
                    this.elements.cameraStatus.className = 'status-dot error';
                }
            }

            updateServiceStatus(isOnline) {
                this.state.isOnline = isOnline;
                
                if (isOnline) {
                    this.elements.serviceStatus.textContent = 'Online';
                    this.elements.serviceIndicator.className = 'status-dot online';
                } else {
                    this.elements.serviceStatus.textContent = 'Offline';
                    this.elements.serviceIndicator.className = 'status-dot error';
                }
            }

            updateLastUpdateTime() {
                const now = new Date();
                this.elements.lastUpdate.textContent = now.toLocaleTimeString();
                this.state.lastUpdate = now.getTime();
            }

            // User interaction handlers
            async refreshAllData() {
                this.showToast('Refreshing all data...', 'info');
                await this.loadAllData();
                this.showToast('Data refreshed successfully', 'success');
            }

            async refreshCamera() {
                this.showToast('Refreshing camera...', 'info');
                await this.updateCameraImage();
            }

            cycleFitMode() {
                const modes = ['contain', 'cover', 'fill'];
                const modeNames = { 
                    contain: 'Fit to View', 
                    cover: 'Fill View', 
                    fill: 'Stretch to Fit' 
                };
                const modeIcons = {
                    contain: '◱',
                    cover: '◰', 
                    fill: '◳'
                };
                
                const currentIndex = modes.indexOf(this.state.imageFitMode);
                this.state.imageFitMode = modes[(currentIndex + 1) % modes.length];
                
                if (this.elements.cameraImage) {
                    this.elements.cameraImage.style.objectFit = this.state.imageFitMode;
                }
                
                // Update button
                this.elements.fitModeBtn.textContent = modeIcons[this.state.imageFitMode];
                this.elements.fitModeBtn.title = `Toggle Fit Mode (${modeNames[this.state.imageFitMode]})`;
                
                this.showToast(`Image mode: ${modeNames[this.state.imageFitMode]}`, 'info');
            }

            toggleFullscreen() {
                if (this.state.isFullscreen) {
                    this.exitFullscreen();
                } else {
                    this.enterFullscreen();
                }
            }

            enterFullscreen() {
                if (!this.elements.cameraImage.src) return;
                
                this.state.isFullscreen = true;
                this.elements.fullscreenImage.src = this.elements.cameraImage.src;
                this.elements.fullscreenModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            exitFullscreen() {
                this.state.isFullscreen = false;
                this.elements.fullscreenModal.classList.remove('active');
                document.body.style.overflow = '';
            }

            async exportData() {
                try {
                    this.showToast('Exporting data...', 'info');
                    
                    const response = await this.fetchWithTimeout('/api/export?hours=24&format=json');
                    const data = await response.text();
                    
                    // Create download
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `parking_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('Data exported successfully', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showToast('Export failed', 'error');
                }
            }

            showZoneDetails(zone) {
                const details = `
                    Zone: ${zone.name}
                    Status: ${zone.occupied ? 'Occupied' : 'Available'}
                    Confidence: ${zone.confidence ? Math.round(zone.confidence * 100) + '%' : 'N/A'}
                    Difficulty: ${zone.name.startsWith('B') ? 'Hard' : 'Easy'}
                `;
                this.showToast(details, 'info');
            }

            // Utility functions
            handleError(error) {
                this.state.retryCount++;
                this.updateServiceStatus(false);
                
                if (this.state.retryCount < this.config.maxRetries) {
                    setTimeout(() => this.loadAllData(), this.config.retryDelay);
                } else {
                    this.showToast('Multiple connection failures detected', 'error');
                }
            }

            handleVisibilityChange() {
                if (document.hidden) {
                    this.state.autoRefresh = false;
                } else {
                    this.state.autoRefresh = true;
                    this.loadAllData(); // Refresh when tab becomes visible again
                }
            }

            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
                toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
                
                this.elements.toastContainer.appendChild(toast);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 3000);
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ParkingMonitorPro();
        });

    </script>
</body>
</html>